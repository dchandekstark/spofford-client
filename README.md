# Spofford::Client

A command line utility and library for interacting with a Spofford server instance.

## Installation

Command line usage, assuming a working Ruby installation:

`gem install spofford-client`

Which will place the `spofford-client` script on your PATH (does this work on Windows?)

To use as a library, place the following in your `Gemfile`: 

```ruby
gem 'spofford-client'
```

And then execute:

    $ bundle install

## Usage

Just the command line for now, library internals may change.

    $ spofford-client [options] file [file2, file3 ...]

The client assumes a default configuration sensible for a testing environment:
```
:base_url => http://localhost:3000
:package_storage_location => './packages'
:owner => (determined by your hostname, viz blahblahblah.[instname].edu)
```

### Options

Most options have a short and a long form, e.g. `-u` and `--url` mean the same thing.  This will be indicated as 
`-short`/`--long` below.

| Option (short/long) | Argument? | Description
----------------------|-----------|--------------
| `-u`/`--u`          | a URL     | The base URL to the Spofford instance (no paths)
| `-o`/`--owner`      | institution code | The owner of the records you're submitting
| `-s`/`--store`      | directory (or filename) | Directory where multi-file ingest packages will be stored
| `-p`/`--package-only` | (none) | Stop after creating ingest package (if necessary)
| `-t`/`--test`       | (none)    | Run in test mode -- shows configuration
| `-v`/`--verbose`    | (none)    | Makes the client chatty about what it's doing
| `-z`/`--force-zip`  | (none)    | Forces creation of ZIP ingest package even when submitting single file
| `-c`/`--config-file`| path to file | A relative path to a YAML configuration file
| `--create-config`   | (none)    | Allows creation of configuration file from command line

The client requires the names of one or more files to be passed in after all the options.  These files must exist
(unless running with `-t`).   For a complete list of options, see [the script source](exe/spofford-client).

Configuration files are not required, but you can create several in order to support multiple submission scenarios 
(e.g. for testing and production) without requiring long command lines.  `--create-config` will allow you to create 
a (or update an existing) configuration interactively, using sensible defaults.  Not all options are supported
with this mechanism, though, so you may need to fire up a text editor for fine-grained control.


### How it Works

The current version of the Spofford server will accept and HTTP POST containing the contents of a single file, either 
a JSON/Argot file or a ZIP archive at the path `/ingest/:owner`.  Argot/JSON files contains new and updated records,
while a ZIP file can contain multiple files, some of which add/update records, and others that include the IDs of 
records to be deleted.  Update files should match the naming pattern `add*.json` while deletes should have names like
`delete*.json`.  See the [Spofford Project](https://github.com/trln/trln-ingest) for more details.

The client supports ingest of:

  * a single Argot/JSON update file
  * a single pre-assembled ZIP archive containing zero or more `add*.json` and `delete*.json` files.
  * multiple JSON files matching the above patterns, which will be assembled into a ZIP before ingest.
  
The client currently does not check for filename conformance, so that's on you for the time being!

The client works to distinguish single `.json` files from single `.zip` files and attempts to do the right thing.  If
multiple filenames are provided, it will attempt to assemble those files into a `zip` file, which will be stored in the
`-s`/`--store` (aka `:package_storage_location`) directory.    This directory will be automatically created the first
time it is needed.

The name of the ingest file will be autogenerated (pattern: `spofford-ingest-#YYYYYMMDDHHmmSS.zip`), *unless* the value 
of the `-s` parameter ends with `.zip`, in which case that value will be interpreted as a filename -- i.e. you can
choose to always overwrite an existing ingest package.  It's probably less confusing to just use the name of a directory
  for this parameter, though =)

### Configuration

The default configuration will be read from `lib/spofford/client/config.rb` (`DEFAULT_OPTIONS`); in addition, if a file 
named `config.yml` is in the current directory, any values found in there will overlay the defaults.  The Finally, any
command-line parameters will be applied.  You can test your configuration by use of the `-t` switch, which will print
out the configuration that *would have been* active had you not supplied the switch.

If you create a file named `config.yml` in the current working directory, configuration will be read from there.  
Additionally, you can specify an alternate configuration file using the `-c`/`--config-file` parameter.
   
## Development

After checking out the repo, run `bin/setup` to install dependencies. Then, run `rake spec` to run the tests. You can also run `bin/console` for an interactive prompt that will allow you to experiment.

To install this gem onto your local machine, run `bundle exec rake install`. To release a new version, update the version number in `version.rb`, and then run `bundle exec rake release`, which will create a git tag for the version, push git commits and tags, and push the `.gem` file to [rubygems.org](https://rubygems.org).

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/trln/spofford-client.

